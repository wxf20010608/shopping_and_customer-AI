## 目标

* 用户在“我的订单”中可删除自己的订单（软删除，不物理移除）。

* 管理员可在后台查看所有“被用户删除”的订单，并且在订单列表中直观看到标记。

## 数据模型与迁移

* 在 `orders` 表新增字段：

  * `deleted_by_user`（boolean，默认 false）

  * `deleted_at`（datetime，可空）

* 在应用启动时进行列检查与增补：

  * 用户侧：`backend/app/main.py` 的 `create_app()` 中使用 SQLite PRAGMA 检查并 `ALTER TABLE` 添加字段（参考现有对 `plan_id`、`discount_type` 等的处理）。

  * 管理员侧：`backend/app/admin_app.py` 启动处同样增补（参考现有增补逻辑 27-45 行）。

## 后端接口（用户侧）

* 新增路由：`DELETE /orders/{user_id}/{order_id}`

  * 文件：`backend/app/routers/orders_route.py`

  * 逻辑：校验用户存在与订单归属，执行软删除：设置 `deleted_by_user=True`、`deleted_at=当前时间`。

* 服务层：`backend/app/services/order_service.py`

  * 新增 `delete_order(user_id, order_id, db)` 执行上述软删除。

  * 更新 `list_orders(user_id, db)` 过滤掉 `deleted_by_user=True` 的订单（用户视图看不到已删除订单）。

  * `get_order(order_id, db)` 保持不变；如需对用户访问已删除订单返回 404，可在路由层加判断（本方案默认用户不会再点击已删除订单）。

## 后端接口（管理员侧）

* 扩展管理端返回字段：在 `schemas.OrderRead` 中新增：

  * `deleted_by_user: bool`

  * `deleted_at: Optional[datetime]`

* 管理员订单查询：

  * `GET /admin/orders` 保持现状，返回全部订单，包含上述两字段供前端显示。

  * 额外筛选接口（可选）：`GET /admin/orders/deleted` 仅返回 `deleted_by_user=True` 的订单，便于专门查看（若你希望在后台单独分栏）。

## 前端改动（用户）

* `frontend/src/views/OrdersView.vue`：在每个订单卡片加入“删除订单”按钮：

  * 点击后二次确认，调用 `api.deleteOrder(userId, orderId)` 执行删除。

  * 成功后从本地列表移除该订单或刷新列表。

* `frontend/src/api/index.js`：新增方法：

  * `deleteOrder(userId, orderId) { return http.delete(\`/orders/${userId}/${orderId}\`); }\`

## 前端改动（管理员）

* `frontend/src/views/admin/AdminDashboard.vue`：订单列表区：

  * 新增一列“用户删除”显示：`是/否` 与 `删除时间`（若存在）。

  * 可选：增加“只看已删除”开关以过滤。

## 权限与约束

* 仅订单归属者可删除该订单；管理员不在用户侧接口权限范围内。

* 软删除不影响物流、财务数据；管理员保留完整查看能力。

* 可选约束（如需）：禁止删除 `pending` 以外状态，或限定在发货前；默认本方案允许任意状态软删除（仅隐藏用户视图）。

## 验证与测试

* 单元测试/集成测试：

  * 新建订单后删除 → 用户列表不再出现、管理员列表显示“用户删除”。

  * 非归属用户删除 → 返回 403/404。

  * 管理员列表筛选“已删除”正确显示。

* 手动验证：前端用户页删除按钮生效，管理员页新增列正确渲染。

## 变更文件（参考位置）

* 模型与迁移：`backend/app/main.py`、`backend/app/admin_app.py`

* Schemas：`backend/app/schemas.py`（`OrderRead` 扩展）

* 路由与服务（用户侧）：

  * `backend/app/routers/orders_route.py`

  * `backend/app/services/order_service.py`

* 前端：

  * `frontend/src/api/index.js`

  * `frontend/src/views/OrdersView.vue`

  * `frontend/src/views/admin/AdminDashboard.vue`

## 风险与回滚

* 作为软删除设计，数据库结构向前兼容；若回滚仅需忽略新增字段。

* 现有查询不依赖新字段，不影响旧功能；管理员新增列若不需要可移除。

