# RAG 完整流程说明

## 概述

RAG (Retrieval-Augmented Generation) 知识库功能已完整集成到客服系统中，实现了从数据准备、检索增强到生成的完整流程。

## 完整流程

### 阶段一：数据准备与索引构建（离线阶段）

#### 1. 文档上传/导入
管理员通过以下方式添加文档：
- **手动创建**：直接输入文本内容
- **文件上传**：支持 PDF、Word、Excel、文本、Markdown、图片（OCR）
- **从URL导入**：从网页提取内容
- **从数据库导入**：从数据库表提取数据

#### 2. 文本预处理（5个步骤）

**步骤1：文本规范化**
- 统一编码（UTF-8）
- 正则表达式去除特殊字符、乱码
- 标准化日期、货币等格式

**步骤2：结构化处理**
- 提取标题、段落、列表
- 处理表格数据（转为Markdown）
- 代码块分离和格式化

**步骤3：内容清理**
- 去除广告、导航栏、页脚等噪音内容
- 过滤低质量文本（过短、无意义内容）
- 去重（完全重复）
- 质量评分（0-1）

**步骤4：分块优化**
- 按语义边界分块（段落、章节）
- 重叠分块避免信息割裂
- 控制分块大小（通常128-512 tokens，可配置）

**步骤5：元数据提取**
- 提取来源、作者、时间等信息
- 添加文档结构标签
- 质量评分标注
- 统计信息

#### 3. 向量化与索引

**向量化**：
- 使用嵌入模型（sentence-transformers）将文本块转换为向量
- 支持多语言模型选择（中文/多语言/英文）
- 向量归一化以便计算余弦相似度

**存储到向量数据库**：
- 使用 FAISS 向量数据库存储向量
- 建立高效的 L2 距离索引
- 每个块对应一个向量ID，存储在 `knowledge_chunks` 表中

**数据库存储**：
- `knowledge_documents` 表：存储文档元数据、内容、质量评分
- `knowledge_chunks` 表：存储文档块、向量ID、块元数据

### 阶段二：检索-增强（Retrieval-Augmented）（在线阶段）

当用户进行客服对话时：

#### 1. 查询向量化
- 使用与文档相同的嵌入模型将用户查询转换为向量
- 向量归一化以便计算余弦相似度

#### 2. 相似度检索
- 在 FAISS 向量索引中搜索最相关的文档块
- 使用 L2 距离计算，转换为相似度分数（0-1）
- 按相似度降序排序，返回 Top-K 结果

#### 3. 相似度阈值过滤
- 只有相似度 >= 阈值（默认0.3）的结果才会被使用
- 可配置 `RAG_SIMILARITY_THRESHOLD` 环境变量

#### 4. 上下文构建
- 从数据库获取检索到的文档块内容
- 按相似度排序组合成上下文文本
- 包含文档来源、相似度等信息

### 阶段三：生成（Generation）

#### 1. 提示词增强
- 如果找到相关知识库内容（相似度 >= 阈值）：
  - 将知识库内容注入系统提示词
  - **明确指示AI优先使用知识库内容回答**
  - 如果知识库内容完全回答了问题，直接使用知识库内容
  - 如果知识库内容部分相关，结合知识库和系统信息回答
  - 如果知识库内容不相关，再使用系统信息回答

- 如果没有找到相关知识库内容（相似度 < 阈值）：
  - 使用常规系统提示词
  - 直接调用大模型回答

#### 2. 大模型生成
- 将增强后的提示词发送给 Qwen 模型
- 生成最终回复
- 保存对话记录

## 代码流程

### 管理员上传文档流程

```
管理员上传文件
  ↓
文档解析（PDF/Word/Excel/图片OCR等）
  ↓
rag_service.add_document()
  ↓
(1) 文本规范化 (text_cleaner.normalize_text)
  ↓
(2) 结构化处理 (text_cleaner.extract_structure)
  ↓
(3) 内容清理 (text_cleaner.clean_content)
  ↓
(4) 分块优化 (text_cleaner.chunk_text_optimized)
  ↓
(5) 元数据提取 (text_cleaner.extract_metadata)
  ↓
向量化 (embed_texts) - 将每个块转换为向量
  ↓
存储到 FAISS 向量索引
  ↓
存储到数据库 (knowledge_documents, knowledge_chunks)
  ↓
完成
```

### 用户对话时的RAG流程

```
用户提交问题
  ↓
customer_service.chat()
  ↓
rag_service.retrieve_context()
  ↓
(1) 向量化查询 (embed_text) - 将用户问题转换为向量
  ↓
(2) 检索 (search) - 在FAISS中搜索最相似的向量
  ↓
(3) 相似度计算 - L2距离转换为相似度分数
  ↓
(4) 阈值过滤 - 过滤低相似度结果
  ↓
(5) 获取块内容 - 从数据库获取文档块
  ↓
(6) 构建上下文 - 按相似度排序组合
  ↓
如果找到相关内容（相似度 >= 阈值）：
  ↓
注入知识库内容到系统提示词
  ↓
指示AI优先使用知识库内容
  ↓
调用大模型生成回复
  ↓
如果没有找到相关内容（相似度 < 阈值）：
  ↓
使用常规系统提示词
  ↓
调用大模型生成回复
```

## 关键配置

### 环境变量

```bash
# 嵌入模型配置
RAG_EMBEDDING_MODEL=BAAI/bge-large-zh-v1.5  # 或通过 RAG_LANGUAGE 自动选择
RAG_LANGUAGE=zh  # zh/chinese, en/english, multilingual/multi

# 分块配置
RAG_CHUNK_SIZE=500          # 块大小（字符）
RAG_CHUNK_OVERLAP=50        # 重叠大小（字符）
RAG_MIN_CHUNK_LENGTH=20     # 最小块长度
RAG_MAX_CHUNK_LENGTH=2000   # 最大块长度

# 检索配置
RAG_TOP_K=3                 # 检索 Top-K 相关文档
RAG_SIMILARITY_THRESHOLD=0.3  # 相似度阈值（0-1），低于此值不使用知识库

# 质量过滤
RAG_QUALITY_THRESHOLD=0.3   # 质量评分阈值
```

## 相似度计算说明

### L2距离 vs 余弦相似度

- **FAISS 使用 L2 距离**：计算向量之间的欧氏距离
- **转换为相似度**：`similarity = 1 / (1 + distance)`
- **归一化向量**：嵌入模型输出已归一化的向量，L2距离和余弦距离高度相关

### 相似度阈值

- **默认阈值**：0.3
- **含义**：只有相似度 >= 0.3 的知识库内容才会被使用
- **调整建议**：
  - 提高阈值（0.5-0.7）：更严格，只使用高度相关的内容
  - 降低阈值（0.1-0.2）：更宽松，使用更多相关内容

## 管理员界面功能

### 知识库管理标签页

1. **创建文档**：手动输入文本创建文档
2. **从数据库导入**：从数据库表导入数据
3. **从URL导入**：从网页URL导入内容
4. **上传文件**：上传PDF、Word、Excel、文本、图片等文件
5. **文档列表**：查看所有文档，支持分类和状态筛选
6. **搜索测试**：测试知识库检索功能
7. **重建索引**：重建向量索引

### 文档列表显示

- 文档ID和标题
- 分类
- 来源类型
- 块数量
- 质量评分
- 状态（有效/无效）

## 客服对话中的RAG使用

### 自动检索

当用户进行客服对话时，系统会自动：
1. 向量化用户查询
2. 在知识库中检索相关内容
3. 如果找到相关内容（相似度 >= 阈值），优先使用知识库内容回答
4. 如果没有找到相关内容，使用大模型直接回答

### 日志输出

系统会输出RAG检索日志：
- `✓ RAG检索成功：找到 N 条相关内容，最高相似度 X.XX`
- `⚠ RAG检索结果相似度较低（X.XX < 阈值），不使用知识库内容`
- `ℹ RAG检索未找到相关内容，将使用大模型直接回答`
- `⚠ RAG 检索失败: 错误信息`

## 完整示例

### 示例1：上传文档并检索

1. **管理员上传文档**：
   ```
   POST /knowledge-base/documents/upload
   FormData: file=policy.pdf, category=售后政策
   ```
   - 系统自动：解析PDF → 清洗 → 分块 → 向量化 → 存储

2. **用户提问**：
   ```
   用户："退换货政策是什么？"
   ```
   - 系统自动：向量化查询 → 检索知识库 → 找到相关内容 → 使用知识库内容回答

### 示例2：从数据库导入

1. **管理员从数据库导入**：
   ```
   POST /knowledge-base/documents/from-database
   {
     "table_name": "products",
     "category": "商品信息"
   }
   ```
   - 系统自动：提取表数据 → 清洗 → 分块 → 向量化 → 存储

2. **用户提问**：
   ```
   用户："这个商品有什么特点？"
   ```
   - 系统自动：检索知识库 → 找到商品信息 → 使用知识库内容回答

## 性能优化建议

1. **模型选择**：
   - 中文内容：使用 `BAAI/bge-large-zh-v1.5`
   - 中英文混合：使用 `intfloat/multilingual-e5-large`

2. **分块大小**：
   - 短文档（< 1000字）：chunk_size = 300-500
   - 中等文档（1000-5000字）：chunk_size = 500-800
   - 长文档（> 5000字）：chunk_size = 800-1200

3. **相似度阈值**：
   - 严格模式：threshold = 0.5-0.7
   - 平衡模式：threshold = 0.3（默认）
   - 宽松模式：threshold = 0.1-0.2

4. **Top-K 数量**：
   - 精确回答：top_k = 1-2
   - 平衡模式：top_k = 3（默认）
   - 全面回答：top_k = 5-10

## 故障排除

### 问题1：知识库内容未被使用

**检查项**：
1. 确认知识库中有文档
2. 检查相似度阈值设置（可能过高）
3. 查看日志，确认检索是否成功
4. 测试搜索功能，确认检索是否正常

### 问题2：检索结果不准确

**解决方案**：
1. 优化文档内容（更清晰、更具体）
2. 调整相似度阈值
3. 增加知识库文档数量
4. 使用更适合的嵌入模型

### 问题3：响应速度慢

**解决方案**：
1. 减少 Top-K 数量
2. 使用更小的嵌入模型
3. 优化分块大小
4. 定期重建索引

---

**RAG 完整流程已实现，系统会自动在客服对话中优先使用知识库内容回答用户问题！**
